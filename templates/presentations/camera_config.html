{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">
                    {{ title }}
                </h1>
                <p class="text-gray-600">
                    Configura tu c√°mara y ajusta la detecci√≥n de gestos para controlar presentaciones
                </p>
            </div>
            <div class="flex space-x-3">
                <a href="{% url 'presentations:home' %}"
                   class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition">
                    ‚Üê Volver
                </a>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Panel de Configuraci√≥n -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                Configuraci√≥n de C√°mara
            </h3>

            <!-- Selecci√≥n de C√°mara -->
            <div class="mb-6">
                <label for="cameraSelect" class="block text-sm font-medium text-gray-700 mb-2">
                    Seleccionar C√°mara
                </label>
                <select id="cameraSelect"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-primary focus:border-primary">
                    <option value="">Detectando c√°maras...</option>
                </select>
            </div>

            <!-- Configuraci√≥n de Sensibilidad -->
            <div class="mb-6">
                <label for="sensitivity" class="block text-sm font-medium text-gray-700 mb-2">
                    Sensibilidad de Detecci√≥n
                </label>
                <input type="range"
                       id="sensitivity"
                       min="0.1"
                       max="1.0"
                       step="0.1"
                       value="0.7"
                       class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                <div class="flex justify-between text-xs text-gray-500 mt-1">
                    <span>Baja</span>
                    <span>Media</span>
                    <span>Alta</span>
                </div>
            </div>

            <!-- Botones de Control -->
            <div class="space-y-3">
                <button id="startCameraBtn"
                        class="w-full bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition">
                    üìπ Iniciar C√°mara
                </button>
                <button id="stopCameraBtn"
                        class="w-full bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition"
                        disabled>
                    ‚èπÔ∏è Detener C√°mara
                </button>
                <button id="testGesturesBtn"
                        class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition"
                        disabled>
                    ü§ö Probar Gestos
                </button>
            </div>

            <!-- Estado de Configuraci√≥n -->
            <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                <h4 class="font-medium text-gray-900 mb-2">Estado Actual</h4>
                <div class="space-y-1 text-sm text-gray-600">
                    <div>C√°mara: <span id="cameraStatus" class="font-medium">No conectada</span></div>
                    <div>Detecci√≥n: <span id="detectionStatus" class="font-medium">Inactiva</span></div>
                    <div>Gestos detectados: <span id="gestureCount" class="font-medium">0</span></div>
                </div>
            </div>
        </div>

        <!-- Panel de Vista Previa -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                Vista Previa de C√°mara
            </h3>

            <!-- Video Preview -->
            <div class="relative bg-gray-900 rounded-lg overflow-hidden mb-4" style="aspect-ratio: 16/9;">
                <video id="cameraVideo"
                       class="w-full h-full object-cover"
                       autoplay
                       muted
                       playsinline>
                </video>
                <canvas id="poseCanvas"
                        class="absolute inset-0 w-full h-full"
                        style="pointer-events: none;">
                </canvas>

                <!-- Overlay de estado -->
                <div id="cameraOverlay" class="absolute inset-0 flex items-center justify-center bg-gray-900 bg-opacity-75">
                    <div class="text-center text-white">
                        <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                        <p class="text-lg font-medium">C√°mara no iniciada</p>
                        <p class="text-sm text-gray-300">Haz clic en "Iniciar C√°mara" para comenzar</p>
                    </div>
                </div>
            </div>

            <!-- Informaci√≥n de Gestos -->
            <div class="bg-blue-50 rounded-lg p-4">
                <h4 class="font-medium text-blue-900 mb-2">Gestos Disponibles</h4>
                <div class="space-y-2 text-sm text-blue-800">
                    <div class="flex items-center">
                        <span class="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center mr-2 text-xs">‚Üí</span>
                        <span>Brazo derecho levantado: Siguiente slide</span>
                    </div>
                    <div class="flex items-center">
                        <span class="w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center mr-2 text-xs">‚Üê</span>
                        <span>Brazo izquierdo levantado: Slide anterior</span>
                    </div>
                </div>
            </div>

            <!-- √öltimo Gesto Detectado -->
            <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                <div class="text-sm text-gray-600">√öltimo gesto:
                    <span id="lastGesture" class="font-medium text-gray-900">Ninguno</span>
                </div>
                <div class="text-xs text-gray-500 mt-1">
                    Hace <span id="gestureTime">--</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MediaPipe tasks-vision CDN (Skypack) -->
<script type="module">
import { PoseLandmarker, FilesetResolver } from "https://cdn.skypack.dev/@mediapipe/tasks-vision@latest";
// Hacer disponibles globalmente
window.PoseLandmarker = PoseLandmarker;
window.FilesetResolver = FilesetResolver;
</script>

<!-- Clases de detecci√≥n de gestos -->
<script src="{% static 'js/gesture_detection.js' %}"></script>

<!-- JavaScript para configuraci√≥n de c√°mara -->
<script>
// Debug: Verificar qu√© variables est√°n disponibles despu√©s de cargar MediaPipe
window.addEventListener('load', function() {
    console.log('Variables globales disponibles:');
    console.log('FilesetResolver:', typeof FilesetResolver);
    console.log('PoseLandmarker:', typeof PoseLandmarker);
    console.log('vision:', typeof vision);
    console.log('window.vision:', typeof window.vision);
    console.log('Todas las keys de window que contienen "mediapipe", "vision", "pose":',
        Object.keys(window).filter(key =>
            key.toLowerCase().includes('mediapipe') ||
            key.toLowerCase().includes('vision') ||
            key.toLowerCase().includes('pose')
        )
    );
});

// Instancias de clases
let gestureDetector = null;
let cameraManager = null;
let cameraConfig = null;

// Referencias DOM
const cameraSelect = document.getElementById('cameraSelect');
const sensitivitySlider = document.getElementById('sensitivity');
const startCameraBtn = document.getElementById('startCameraBtn');
const stopCameraBtn = document.getElementById('stopCameraBtn');
const testGesturesBtn = document.getElementById('testGesturesBtn');
const cameraVideo = document.getElementById('cameraVideo');
const poseCanvas = document.getElementById('poseCanvas');
const cameraOverlay = document.getElementById('cameraOverlay');

// Estados
const cameraStatus = document.getElementById('cameraStatus');
const detectionStatus = document.getElementById('detectionStatus');
const gestureCountEl = document.getElementById('gestureCount');
const lastGestureEl = document.getElementById('lastGesture');
const gestureTimeEl = document.getElementById('gestureTime');

// Contador de gestos
let gestureCount = 0;

// Inicializaci√≥n cuando se carga la p√°gina
document.addEventListener('DOMContentLoaded', function() {
    // Esperar a que MediaPipe est√© disponible
    waitForMediaPipe().then(() => {
        initializePage();
    }).catch(error => {
        console.error('Error esperando MediaPipe:', error);
        alert('Error cargando MediaPipe: ' + error.message);
    });
});

// Funci√≥n para esperar a que MediaPipe est√© disponible
function waitForMediaPipe() {
    return new Promise((resolve, reject) => {
        let attempts = 0;
        const maxAttempts = 50; // 5 segundos m√°ximo

        const checkMediaPipe = () => {
            if (window.FilesetResolver && window.PoseLandmarker) {
                console.log('MediaPipe cargado correctamente');
                resolve();
            } else if (attempts < maxAttempts) {
                attempts++;
                setTimeout(checkMediaPipe, 100);
            } else {
                reject(new Error('MediaPipe no se carg√≥ despu√©s de 5 segundos'));
            }
        };

        checkMediaPipe();
    });
}

async function initializePage() {
    try {
        // Inicializar clases
        gestureDetector = new GestureDetector();
        cameraManager = new CameraManager();
        cameraConfig = new CameraConfig();

        // Configurar callbacks del detector de gestos
        gestureDetector.onGestureDetected = handleGestureDetected;
        gestureDetector.onPoseDetected = handlePoseDetected;
        gestureDetector.onError = handleDetectionError;

        // Cargar configuraci√≥n guardada
        loadSavedConfig();

        // Detectar c√°maras disponibles
        await detectCameras();

        // Configurar event listeners
        setupEventListeners();

        console.log('P√°gina de configuraci√≥n inicializada correctamente');

    } catch (error) {
        console.error('Error inicializando p√°gina:', error);
        alert('Error de inicializaci√≥n: ' + error.message);
    }
}

function loadSavedConfig() {
    const config = cameraConfig.load();

    // Aplicar configuraci√≥n a UI
    sensitivitySlider.value = config.sensitivity;

    // Aplicar configuraci√≥n al detector
    if (gestureDetector) {
        gestureDetector.setSensitivity(config.sensitivity);
    }

    console.log('Configuraci√≥n cargada:', config);
}

function saveConfig() {
    const config = {
        sensitivity: parseFloat(sensitivitySlider.value),
        selectedCamera: cameraSelect.value
    };

    cameraConfig.save(config);

    // Aplicar nueva sensibilidad al detector
    if (gestureDetector) {
        gestureDetector.setSensitivity(config.sensitivity);
    }
}

async function detectCameras() {
    try {
        cameraSelect.innerHTML = '<option value="">Detectando c√°maras...</option>';

        const devices = await cameraManager.detectCameras();

        // Limpiar opciones
        cameraSelect.innerHTML = '';

        if (devices.length === 0) {
            cameraSelect.innerHTML = '<option value="">No se encontraron c√°maras</option>';
            return;
        }

        // A√±adir opciones de c√°mara
        devices.forEach((device, index) => {
            const option = document.createElement('option');
            option.value = device.deviceId;
            option.textContent = device.label || `C√°mara ${index + 1}`;
            cameraSelect.appendChild(option);
        });

        // Seleccionar c√°mara guardada si existe
        const savedConfig = cameraConfig.load();
        if (savedConfig.selectedCamera) {
            cameraSelect.value = savedConfig.selectedCamera;
        }

        console.log(`${devices.length} c√°maras detectadas`);

    } catch (error) {
        console.error('Error detectando c√°maras:', error);
        cameraSelect.innerHTML = '<option value="">Error: Permisos de c√°mara denegados</option>';
    }
}

function setupEventListeners() {
    startCameraBtn.addEventListener('click', startCamera);
    stopCameraBtn.addEventListener('click', stopCamera);
    testGesturesBtn.addEventListener('click', toggleGestureDetection);

    // Guardar configuraci√≥n cuando cambie
    sensitivitySlider.addEventListener('input', saveConfig);
    cameraSelect.addEventListener('change', saveConfig);
}

async function startCamera() {
    try {
        const deviceId = cameraSelect.value;
        if (!deviceId) {
            alert('Por favor selecciona una c√°mara');
            return;
        }

        await cameraManager.startCamera(deviceId, cameraVideo);

        // Actualizar UI
        cameraOverlay.style.display = 'none';
        startCameraBtn.disabled = true;
        stopCameraBtn.disabled = false;
        testGesturesBtn.disabled = false;

        updateCameraStatus('Conectada', true);

        console.log('C√°mara iniciada correctamente');

    } catch (error) {
        console.error('Error iniciando c√°mara:', error);
        alert('Error al iniciar la c√°mara: ' + error.message);
    }
}

function stopCamera() {
    // Detener detecci√≥n si est√° activa
    if (gestureDetector && gestureDetector.isDetecting) {
        toggleGestureDetection();
    }

    // Detener c√°mara
    cameraManager.stopCamera();

    // Actualizar UI
    cameraOverlay.style.display = 'flex';
    startCameraBtn.disabled = false;
    stopCameraBtn.disabled = true;
    testGesturesBtn.disabled = true;

    updateCameraStatus('No conectada', false);

    console.log('C√°mara detenida');
}

async function toggleGestureDetection() {
    try {
        if (!gestureDetector.isDetecting) {
            // Iniciar detecci√≥n
            await gestureDetector.startDetection(cameraVideo);

            testGesturesBtn.textContent = '‚èπÔ∏è Detener Gestos';
            updateDetectionStatus('Activa', true);

        } else {
            // Detener detecci√≥n
            gestureDetector.stopDetection();

            testGesturesBtn.textContent = 'ü§ö Probar Gestos';
            updateDetectionStatus('Inactiva', false);

            // Limpiar canvas
            const ctx = poseCanvas.getContext('2d');
            ctx.clearRect(0, 0, poseCanvas.width, poseCanvas.height);
        }

    } catch (error) {
        console.error('Error en detecci√≥n de gestos:', error);
        alert('Error en detecci√≥n de gestos: ' + error.message);
    }
}

// Callbacks para eventos de detecci√≥n
function handleGestureDetected(gestureData) {
    gestureCount++;
    gestureCountEl.textContent = gestureCount;
    lastGestureEl.textContent = gestureData.description;
    gestureTimeEl.textContent = 'ahora';

    console.log('Gesto detectado:', gestureData);

    // Aqu√≠ se podr√≠a enviar el gesto a la presentaci√≥n
    // TODO: Integrar con sistema de navegaci√≥n de slides
}

function handlePoseDetected(landmarks) {
    // Opcional: Dibujar pose en canvas
    drawPoseOnCanvas(landmarks);
}

function handleDetectionError(error) {
    console.error('Error de detecci√≥n:', error);
    updateDetectionStatus('Error: ' + error, false);
}

// Utilidades de UI
function updateCameraStatus(text, isActive) {
    cameraStatus.textContent = text;
    if (isActive) {
        cameraStatus.classList.add('text-green-600');
    } else {
        cameraStatus.classList.remove('text-green-600');
    }
}

function updateDetectionStatus(text, isActive) {
    detectionStatus.textContent = text;
    if (isActive) {
        detectionStatus.classList.add('text-green-600');
    } else {
        detectionStatus.classList.remove('text-green-600');
    }
}

function drawPoseOnCanvas(landmarks) {
    const canvas = poseCanvas;
    const ctx = canvas.getContext('2d');

    // Ajustar tama√±o del canvas al video
    if (cameraVideo.videoWidth && cameraVideo.videoHeight) {
        canvas.width = cameraVideo.videoWidth;
        canvas.height = cameraVideo.videoHeight;
    }

    // Limpiar canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Dibujar landmarks principales (hombros, codos, mu√±ecas)
    const keyPoints = [11, 12, 13, 14, 15, 16]; // Landmarks de brazos

    ctx.fillStyle = '#00ff00';
    ctx.strokeStyle = '#00ff00';
    ctx.lineWidth = 2;

    keyPoints.forEach(index => {
        const landmark = landmarks[index];
        if (landmark) {
            const x = landmark.x * canvas.width;
            const y = landmark.y * canvas.height;

            // Dibujar punto
            ctx.beginPath();
            ctx.arc(x, y, 5, 0, 2 * Math.PI);
            ctx.fill();
        }
    });

    // Dibujar conexiones de brazos
    drawConnection(ctx, landmarks, 11, 13, canvas); // Hombro izq -> Codo izq
    drawConnection(ctx, landmarks, 13, 15, canvas); // Codo izq -> Mu√±eca izq
    drawConnection(ctx, landmarks, 12, 14, canvas); // Hombro der -> Codo der
    drawConnection(ctx, landmarks, 14, 16, canvas); // Codo der -> Mu√±eca der
}

function drawConnection(ctx, landmarks, fromIndex, toIndex, canvas) {
    const from = landmarks[fromIndex];
    const to = landmarks[toIndex];

    if (from && to) {
        ctx.beginPath();
        ctx.moveTo(from.x * canvas.width, from.y * canvas.height);
        ctx.lineTo(to.x * canvas.width, to.y * canvas.height);
        ctx.stroke();
    }
}
</script>
{% endblock %}